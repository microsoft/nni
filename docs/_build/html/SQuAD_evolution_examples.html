

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Automatic Model Architecture Search for Reading Comprehension &mdash; Neural Network Intelligence v0.5.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="GBDT in nni" href="gbdt_example.html" />
    <link rel="prev" title="Scikit-learn in NNI" href="sklearn_examples.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html">
          

          
            
            <img src="_static/nni_logo_dark.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="QuickStart.html">QuickStart</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="Tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Installation.html">Installation of NNI</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="Trials.html">Write Trial</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="mnist_examples.html">MNIST examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="cifar10_examples.html">Finding out best optimizer for Cifar10 classification</a></li>
<li class="toctree-l3"><a class="reference internal" href="sklearn_examples.html">How to tune Scikit-learn on NNI</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Automatic Model Architecture Search for Reading Comprehension.</a></li>
<li class="toctree-l3"><a class="reference internal" href="gbdt_example.html">Tuning GBDT on NNI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tuners.html">Tuners</a></li>
<li class="toctree-l2"><a class="reference internal" href="assessors.html">Assessors</a></li>
<li class="toctree-l2"><a class="reference internal" href="WebUI.html">WebUI</a></li>
<li class="toctree-l2"><a class="reference internal" href="training_services.html">Training Platform</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html">Advanced Features</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reference.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="Contribution.html">Contribute to NNI</a></li>
<li class="toctree-l1"><a class="reference internal" href="RELEASE.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Neural Network Intelligence</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="Overview.html">Overview</a> &raquo;</li>
        
          <li><a href="QuickStart.html">QuickStart</a> &raquo;</li>
        
          <li><a href="Trials.html">Write a Trial Run on NNI</a> &raquo;</li>
        
      <li>Automatic Model Architecture Search for Reading Comprehension</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/SQuAD_evolution_examples.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="automatic-model-architecture-search-for-reading-comprehension">
<h1>Automatic Model Architecture Search for Reading Comprehension<a class="headerlink" href="#automatic-model-architecture-search-for-reading-comprehension" title="Permalink to this headline">¶</a></h1>
<p>This example shows us how to use Genetic Algorithm to find good model architectures for Reading Comprehension.</p>
<div class="section" id="search-space">
<h2>1. Search Space<a class="headerlink" href="#search-space" title="Permalink to this headline">¶</a></h2>
<p>Since attention and recurrent neural network (RNN) have been proven effective in Reading Comprehension.
We conclude the search space as follow:</p>
<ol class="simple">
<li>IDENTITY (Effectively means keep training).</li>
<li>INSERT-RNN-LAYER (Inserts a LSTM. Comparing the performance of GRU and LSTM in our experiment, we decided to use LSTM here.)</li>
<li>REMOVE-RNN-LAYER</li>
<li>INSERT-ATTENTION-LAYER(Inserts an attention layer.)</li>
<li>REMOVE-ATTENTION-LAYER</li>
<li>ADD-SKIP (Identity between random layers).</li>
<li>REMOVE-SKIP (Removes random skip).</li>
</ol>
<p><img alt="https://github.com/Microsoft/nni/tree/master/examples/trials/ga_squad/ga_squad.png" src="https://github.com/Microsoft/nni/tree/master/examples/trials/ga_squad/ga_squad.png" /></p>
<div class="section" id="new-version">
<h3>New version<a class="headerlink" href="#new-version" title="Permalink to this headline">¶</a></h3>
<p>Also we have another version which time cost is less and performance is better. We will release soon.</p>
</div>
</div>
<div class="section" id="how-to-run-this-example-in-local">
<h2>2. How to run this example in local?<a class="headerlink" href="#how-to-run-this-example-in-local" title="Permalink to this headline">¶</a></h2>
<div class="section" id="use-downloading-script-to-download-data">
<h3>2.1 Use downloading script to download data<a class="headerlink" href="#use-downloading-script-to-download-data" title="Permalink to this headline">¶</a></h3>
<p>Execute the following command to download needed files
using the downloading script:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>chmod +x ./download.sh
./download.sh
</pre></div>
</div>
<p>Or Download manually</p>
<ol class="simple">
<li>download “dev-v1.1.json” and “train-v1.1.json” in https://rajpurkar.github.io/SQuAD-explorer/</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget https://rajpurkar.github.io/SQuAD-explorer/dataset/train-v1.1.json
wget https://rajpurkar.github.io/SQuAD-explorer/dataset/dev-v1.1.json
</pre></div>
</div>
<ol class="simple">
<li>download “glove.840B.300d.txt” in https://nlp.stanford.edu/projects/glove/</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget http://nlp.stanford.edu/data/glove.840B.300d.zip
unzip glove.840B.300d.zip
</pre></div>
</div>
</div>
<div class="section" id="update-configuration">
<h3>2.2 Update configuration<a class="headerlink" href="#update-configuration" title="Permalink to this headline">¶</a></h3>
<p>Modify <code class="docutils literal notranslate"><span class="pre">nni/examples/trials/ga_squad/config.yml</span></code>, here is the default configuration:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">authorName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">experimentName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">example_ga_squad</span>
<span class="nt">trialConcurrency</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nt">maxExecDuration</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1h</span>
<span class="nt">maxTrialNum</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="c1">#choice: local, remote</span>
<span class="nt">trainingServicePlatform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>
<span class="c1">#choice: true, false</span>
<span class="nt">useAnnotation</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="nt">tuner</span><span class="p">:</span>
  <span class="nt">codeDir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">~/nni/examples/tuners/ga_customer_tuner</span>
  <span class="nt">classFileName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">customer_tuner.py</span>
  <span class="nt">className</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CustomerTuner</span>
  <span class="nt">classArgs</span><span class="p">:</span>
    <span class="nt">optimize_mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">maximize</span>
<span class="nt">trial</span><span class="p">:</span>
  <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python3 trial.py</span>
  <span class="nt">codeDir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">~/nni/examples/trials/ga_squad</span>
  <span class="nt">gpuNum</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
</pre></div>
</div>
<p>In the “trial” part, if you want to use GPU to perform the architecture search, change <code class="docutils literal notranslate"><span class="pre">gpuNum</span></code> from <code class="docutils literal notranslate"><span class="pre">0</span></code> to <code class="docutils literal notranslate"><span class="pre">1</span></code>. You need to increase the <code class="docutils literal notranslate"><span class="pre">maxTrialNum</span></code> and <code class="docutils literal notranslate"><span class="pre">maxExecDuration</span></code>, according to how long you want to wait for the search result.</p>
</div>
<div class="section" id="submit-this-job">
<h3>2.3 submit this job<a class="headerlink" href="#submit-this-job" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>nnictl create --config ~/nni/examples/trials/ga_squad/config.yml
</pre></div>
</div>
</div>
</div>
<div class="section" id="run-this-example-on-openpai">
<h2>3 Run this example on OpenPAI<a class="headerlink" href="#run-this-example-on-openpai" title="Permalink to this headline">¶</a></h2>
<p>Due to the memory limitation of upload, we only upload the source code and complete the data download and training on OpenPAI. This experiment requires sufficient memory that <code class="docutils literal notranslate"><span class="pre">memoryMB</span> <span class="pre">&gt;=</span> <span class="pre">32G</span></code>, and the training may last for several hours.</p>
<div class="section" id="id1">
<h3>3.1 Update configuration<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Modify <code class="docutils literal notranslate"><span class="pre">nni/examples/trials/ga_squad/config_pai.yml</span></code>, here is the default configuration:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">authorName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">experimentName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">example_ga_squad</span>
<span class="nt">trialConcurrency</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nt">maxExecDuration</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1h</span>
<span class="nt">maxTrialNum</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="c1">#choice: local, remote, pai</span>
<span class="nt">trainingServicePlatform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pai</span>
<span class="c1">#choice: true, false</span>
<span class="nt">useAnnotation</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="c1">#Your nni_manager ip</span>
<span class="nt">nniManagerIp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.10.10.10</span>
<span class="nt">tuner</span><span class="p">:</span>
  <span class="nt">codeDir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://github.com/Microsoft/nni/tree/master/examples/tuners/ga_customer_tuner</span>
  <span class="nt">classFileName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">customer_tuner.py</span>
  <span class="nt">className</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CustomerTuner</span>
  <span class="nt">classArgs</span><span class="p">:</span>
    <span class="nt">optimize_mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">maximize</span>
<span class="nt">trial</span><span class="p">:</span>
  <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">chmod +x ./download.sh &amp;&amp; ./download.sh &amp;&amp; python3 trial.py</span>
  <span class="nt">codeDir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>
  <span class="nt">gpuNum</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="nt">cpuNum</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="nt">memoryMB</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">32869</span>
  <span class="c1">#The docker image to run nni job on OpenPAI</span>
  <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">msranni/nni:latest</span>
  <span class="c1">#The hdfs directory to store data on OpenPAI, format &#39;hdfs://host:port/directory&#39;</span>
  <span class="nt">dataDir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">hdfs://10.10.10.10:9000/username/nni</span>
  <span class="c1">#The hdfs directory to store output data generated by nni, format &#39;hdfs://host:port/directory&#39;</span>
  <span class="nt">outputDir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">hdfs://10.10.10.10:9000/username/nni</span>
<span class="nt">paiConfig</span><span class="p">:</span>
  <span class="c1">#The username to login OpenPAI</span>
  <span class="nt">userName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">username</span>
  <span class="c1">#The password to login OpenPAI</span>
  <span class="nt">passWord</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">password</span>
  <span class="c1">#The host of restful server of OpenPAI</span>
  <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.10.10.10</span>
</pre></div>
</div>
<p>Please change the default value to your personal account and machine information. Including <code class="docutils literal notranslate"><span class="pre">nniManagerIp</span></code>, <code class="docutils literal notranslate"><span class="pre">dataDir</span></code>, <code class="docutils literal notranslate"><span class="pre">outputDir</span></code>, <code class="docutils literal notranslate"><span class="pre">userName</span></code>, <code class="docutils literal notranslate"><span class="pre">passWord</span></code> and <code class="docutils literal notranslate"><span class="pre">host</span></code>.</p>
<p>In the “trial” part, if you want to use GPU to perform the architecture search, change <code class="docutils literal notranslate"><span class="pre">gpuNum</span></code> from <code class="docutils literal notranslate"><span class="pre">0</span></code> to <code class="docutils literal notranslate"><span class="pre">1</span></code>. You need to increase the <code class="docutils literal notranslate"><span class="pre">maxTrialNum</span></code> and <code class="docutils literal notranslate"><span class="pre">maxExecDuration</span></code>, according to how long you want to wait for the search result.</p>
<p><code class="docutils literal notranslate"><span class="pre">trialConcurrency</span></code> is the number of trials running concurrently, which is the number of GPUs you want to use, if you are setting <code class="docutils literal notranslate"><span class="pre">gpuNum</span></code> to 1.</p>
</div>
<div class="section" id="id2">
<h3>3.2 submit this job<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>nnictl create --config ~/nni/examples/trials/ga_squad/config_pai.yml
</pre></div>
</div>
</div>
</div>
<div class="section" id="technical-details-about-the-trial">
<h2>4. Technical details about the trial<a class="headerlink" href="#technical-details-about-the-trial" title="Permalink to this headline">¶</a></h2>
<div class="section" id="how-does-it-works">
<h3>4.1 How does it works<a class="headerlink" href="#how-does-it-works" title="Permalink to this headline">¶</a></h3>
<p>The evolution-algorithm based architecture for question answering has two different parts just like any other examples: the trial and the tuner.</p>
</div>
<div class="section" id="the-trial">
<h3>4.2 The trial<a class="headerlink" href="#the-trial" title="Permalink to this headline">¶</a></h3>
<p>The trial has a lot of different files, functions and classes. Here we will only give most of those files a brief introduction:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">attention.py</span></code> contains an implementation for attention mechanism in Tensorflow.</li>
<li><code class="docutils literal notranslate"><span class="pre">data.py</span></code> contains functions for data preprocessing.</li>
<li><code class="docutils literal notranslate"><span class="pre">evaluate.py</span></code> contains the evaluation script.</li>
<li><code class="docutils literal notranslate"><span class="pre">graph.py</span></code> contains the definition of the computation graph.</li>
<li><code class="docutils literal notranslate"><span class="pre">rnn.py</span></code> contains an implementation for GRU in Tensorflow.</li>
<li><code class="docutils literal notranslate"><span class="pre">train_model.py</span></code> is a wrapper for the whole question answering model.</li>
</ul>
<p>Among those files, <code class="docutils literal notranslate"><span class="pre">trial.py</span></code> and <code class="docutils literal notranslate"><span class="pre">graph_to_tf.py</span></code> are special.</p>
<p><code class="docutils literal notranslate"><span class="pre">graph_to_tf.py</span></code> has a function named as <code class="docutils literal notranslate"><span class="pre">graph_to_network</span></code>, here is its skeleton code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">graph_to_network</span><span class="p">(</span><span class="n">input1</span><span class="p">,</span>
                     <span class="n">input2</span><span class="p">,</span>
                     <span class="n">input1_lengths</span><span class="p">,</span>
                     <span class="n">input2_lengths</span><span class="p">,</span>
                     <span class="n">graph</span><span class="p">,</span>
                     <span class="n">dropout_rate</span><span class="p">,</span>
                     <span class="n">is_training</span><span class="p">,</span>
                     <span class="n">num_heads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">rnn_units</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
    <span class="n">topology</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">is_topology</span><span class="p">()</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">layers_sequence_lengths</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">num_units</span> <span class="o">=</span> <span class="n">input1</span><span class="o">.</span><span class="n">get_shape</span><span class="p">()</span><span class="o">.</span><span class="n">as_list</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">input1</span><span class="o">*</span><span class="n">tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">num_units</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span> <span class="o">+</span> \
        <span class="n">positional_encoding</span><span class="p">(</span><span class="n">input1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">zero_pad</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">input2</span><span class="o">*</span><span class="n">tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">num_units</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dropout</span><span class="p">(</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dropout_rate</span><span class="p">,</span> <span class="n">is_training</span><span class="p">)</span>
    <span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dropout</span><span class="p">(</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dropout_rate</span><span class="p">,</span> <span class="n">is_training</span><span class="p">)</span>
    <span class="n">layers_sequence_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">input1_lengths</span>
    <span class="n">layers_sequence_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">input2_lengths</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">topo_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">topology</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">topo_i</span> <span class="o">==</span> <span class="s1">&#39;|&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">graph</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">topo_i</span><span class="p">]</span><span class="o">.</span><span class="n">graph_type</span> <span class="o">==</span> <span class="n">LayerType</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="c1"># ......</span>
        <span class="k">elif</span> <span class="n">graph</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">topo_i</span><span class="p">]</span><span class="o">.</span><span class="n">graph_type</span> <span class="o">==</span> <span class="n">LayerType</span><span class="o">.</span><span class="n">attention</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="c1"># ......</span>
        <span class="c1"># More layers to handle</span>
</pre></div>
</div>
<p>As we can see, this function is actually a compiler, that converts the internal model DAG configuration (which will be introduced in the <code class="docutils literal notranslate"><span class="pre">Model</span> <span class="pre">configuration</span> <span class="pre">format</span></code> section) <code class="docutils literal notranslate"><span class="pre">graph</span></code>, to a Tensorflow computation graph.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">topology</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">is_topology</span><span class="p">()</span>
</pre></div>
</div>
<p>performs topological sorting on the internal graph representation, and the code inside the loop:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">topo_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">topology</span><span class="p">):</span>
</pre></div>
</div>
<p>performs actually conversion that maps each layer to a part in Tensorflow computation graph.</p>
</div>
<div class="section" id="the-tuner">
<h3>4.3 The tuner<a class="headerlink" href="#the-tuner" title="Permalink to this headline">¶</a></h3>
<p>The tuner is much more simple than the trial. They actually share the same <code class="docutils literal notranslate"><span class="pre">graph.py</span></code>. Besides, the tuner has a <code class="docutils literal notranslate"><span class="pre">customer_tuner.py</span></code>, the most important class in which is <code class="docutils literal notranslate"><span class="pre">CustomerTuner</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CustomerTuner</span><span class="p">(</span><span class="n">Tuner</span><span class="p">):</span>
    <span class="c1"># ......</span>

    <span class="k">def</span> <span class="nf">generate_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a set of trial graph config, as a serializable object.</span>
<span class="sd">        parameter_id : int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;the len of poplution lower than zero.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The population is empty&#39;</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">result</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">indiv</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">graph_dumps</span><span class="p">(</span><span class="n">indiv</span><span class="o">.</span><span class="n">config</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">result</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">indiv</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">indiv</span><span class="o">.</span><span class="n">mutation</span><span class="p">()</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="n">indiv</span><span class="o">.</span><span class="n">config</span>
            <span class="n">temp</span> <span class="o">=</span>  <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">graph_dumps</span><span class="p">(</span><span class="n">graph</span><span class="p">))</span>

    <span class="c1"># ......</span>
</pre></div>
</div>
<p>As we can see, the overloaded method <code class="docutils literal notranslate"><span class="pre">generate_parameters</span></code> implements a pretty naive mutation algorithm. The code lines:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">result</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">indiv</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p>controls the mutation process. It will always take two random individuals in the population, only keeping and mutating the one with better result.</p>
</div>
<div class="section" id="model-configuration-format">
<h3>4.4 Model configuration format<a class="headerlink" href="#model-configuration-format" title="Permalink to this headline">¶</a></h3>
<p>Here is an example of the model configuration, which is passed from the tuner to the trial in the architecture search procedure.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;max_layer_num&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
    <span class="nt">&quot;layers&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="nt">&quot;output_size&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;input&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span>
            <span class="nt">&quot;output&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
            <span class="nt">&quot;is_delete&quot;</span><span class="p">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="nt">&quot;output_size&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;input&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="nt">&quot;output&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
            <span class="nt">&quot;is_delete&quot;</span><span class="p">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="nt">&quot;output_size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;input&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">],</span>
            <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span>
            <span class="nt">&quot;output&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="nt">&quot;is_delete&quot;</span><span class="p">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;input_size&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="nt">&quot;output_size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;input&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">],</span>
            <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="nt">&quot;output&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="nt">&quot;is_delete&quot;</span><span class="p">:</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="p">{</span><span class="nt">&quot;Comment&quot;</span><span class="p">:</span> <span class="s2">&quot;More layers will be here for actual graphs.&quot;</span><span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Every model configuration will have a “layers” section, which is a JSON list of layer definitions. The definition of each layer is also a JSON object, where:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">type</span></code> is the type of the layer. 0, 1, 2, 3, 4 corresponds to attention, self-attention, RNN, input and output layer respectively.</li>
<li><code class="docutils literal notranslate"><span class="pre">size</span></code> is the length of the output. “x”, “y” correspond to document length / question length, respectively.</li>
<li><code class="docutils literal notranslate"><span class="pre">input_size</span></code> is the number of inputs the layer has.</li>
<li><code class="docutils literal notranslate"><span class="pre">input</span></code> is the indices of layers taken as input of this layer.</li>
<li><code class="docutils literal notranslate"><span class="pre">output</span></code> is the indices of layers use this layer’s output as their input.</li>
<li><code class="docutils literal notranslate"><span class="pre">is_delete</span></code> means whether the layer is still available.</li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="gbdt_example.html" class="btn btn-neutral float-right" title="GBDT in nni" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="sklearn_examples.html" class="btn btn-neutral" title="Scikit-learn in NNI" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Microsoft

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>