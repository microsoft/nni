

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Run an Experiment on FrameworkController &mdash; Neural Network Intelligence v0.5.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Customize-Tuner" href="Customize_Tuner.html" />
    <link rel="prev" title="Run an Experiment on Kubeflow" href="KubeflowMode.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html">
          

          
            
            <img src="_static/nni_logo_dark.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="QuickStart.html">QuickStart</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="Tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Installation.html">Installation of NNI</a></li>
<li class="toctree-l2"><a class="reference internal" href="Trials.html">Write Trial</a></li>
<li class="toctree-l2"><a class="reference internal" href="tuners.html">Tuners</a></li>
<li class="toctree-l2"><a class="reference internal" href="assessors.html">Assessors</a></li>
<li class="toctree-l2"><a class="reference internal" href="WebUI.html">WebUI</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="training_services.html">Training Platform</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="tutorial_1_CR_exp_local_api.html">Local</a></li>
<li class="toctree-l3"><a class="reference internal" href="RemoteMachineMode.html">Remote</a></li>
<li class="toctree-l3"><a class="reference internal" href="PAIMode.html">OpenPAI</a></li>
<li class="toctree-l3"><a class="reference internal" href="KubeflowMode.html">Kubeflow</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">FrameworkController</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html">Advanced Features</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reference.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="Contribution.html">Contribute to NNI</a></li>
<li class="toctree-l1"><a class="reference internal" href="RELEASE.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Neural Network Intelligence</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="Overview.html">Overview</a> &raquo;</li>
        
          <li><a href="QuickStart.html">QuickStart</a> &raquo;</li>
        
      <li><strong>Run an Experiment on FrameworkController</strong></li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/FrameworkControllerMode.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="run-an-experiment-on-frameworkcontroller">
<h1><strong>Run an Experiment on FrameworkController</strong><a class="headerlink" href="#run-an-experiment-on-frameworkcontroller" title="Permalink to this headline">¶</a></h1>
<p>NNI supports running experiment using <a class="reference external" href="https://github.com/Microsoft/frameworkcontroller">FrameworkController</a>, called frameworkcontroller mode. FrameworkController is built to orchestrate all kinds of applications on Kubernetes, you don’t need to install kubeflow for specific deeplearning framework like tf-operator or pytorch-operator. Now you can use frameworkcontroller as the training service to run NNI experiment.</p>
<div class="section" id="prerequisite-for-on-premises-kubernetes-service">
<h2>Prerequisite for on-premises Kubernetes Service<a class="headerlink" href="#prerequisite-for-on-premises-kubernetes-service" title="Permalink to this headline">¶</a></h2>
<ol>
<li><p class="first">A <strong>Kubernetes</strong> cluster using Kubernetes 1.8 or later. Follow this <a class="reference external" href="https://kubernetes.io/docs/setup/">guideline</a> to set up Kubernetes</p>
</li>
<li><p class="first">Prepare a <strong>kubeconfig</strong> file, which will be used by NNI to interact with your kubernetes API server. By default, NNI manager will use $(HOME)/.kube/config as kubeconfig file’s path. You can also specify other kubeconfig files by setting the <strong>KUBECONFIG</strong> environment variable. Refer this <a class="reference external" href="https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig">guideline</a> to learn more about kubeconfig.</p>
</li>
<li><p class="first">If your NNI trial job needs GPU resource, you should follow this <a class="reference external" href="https://github.com/NVIDIA/k8s-device-plugin">guideline</a> to configure <strong>Nvidia device plugin for Kubernetes</strong>.</p>
</li>
<li><p class="first">Prepare a <strong>NFS server</strong> and export a general purpose mount (we recommend to map your NFS server path in <code class="docutils literal notranslate"><span class="pre">root_squash</span> <span class="pre">option</span></code>, otherwise permission issue may raise when NNI copies files to NFS. Refer this <a class="reference external" href="https://linux.die.net/man/5/exports">page</a> to learn what root_squash option is), or <strong>Azure File Storage</strong>.</p>
</li>
<li><p class="first">Install <strong>NFS client</strong> on the machine where you install NNI and run nnictl to create experiment. Run this command to install NFSv4 client:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">nfs</span><span class="o">-</span><span class="n">common</span> 
</pre></div>
</div>
</li>
<li><p class="first">Install <strong>NNI</strong>, follow the install guide <a class="reference internal" href="QuickStart.html"><span class="doc">here</span></a>.</p>
</li>
</ol>
</div>
<div class="section" id="prerequisite-for-azure-kubernetes-service">
<h2>Prerequisite for Azure Kubernetes Service<a class="headerlink" href="#prerequisite-for-azure-kubernetes-service" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li>NNI support kubeflow based on Azure Kubernetes Service, follow the <a class="reference external" href="https://azure.microsoft.com/en-us/services/kubernetes-service/">guideline</a> to set up Azure Kubernetes Service.</li>
<li>Install <a class="reference external" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">Azure CLI</a> and <strong>kubectl</strong>.  Use <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">login</span></code> to set azure account, and connect kubectl client to AKS, refer this <a class="reference external" href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-walkthrough#connect-to-the-cluster">guideline</a>.</li>
<li>Follow the <a class="reference external" href="https://docs.microsoft.com/en-us/azure/storage/common/storage-quickstart-create-account?tabs=portal">guideline</a> to create azure file storage account. If you use Azure Kubernetes Service, NNI need Azure Storage Service to store code files and the output files.</li>
<li>To access Azure storage service, NNI need the access key of the storage account, and NNI uses <a class="reference external" href="https://azure.microsoft.com/en-us/services/key-vault/">Azure Key Vault</a> Service to protect your private key. Set up Azure Key Vault Service, add a secret to Key Vault to store the access key of Azure storage account. Follow this <a class="reference external" href="https://docs.microsoft.com/en-us/azure/key-vault/quick-create-cli">guideline</a> to store the access key.</li>
</ol>
</div>
<div class="section" id="set-up-frameworkcontroller">
<h2>Set up FrameworkController<a class="headerlink" href="#set-up-frameworkcontroller" title="Permalink to this headline">¶</a></h2>
<p>Follow the <a class="reference external" href="https://github.com/Microsoft/frameworkcontroller/tree/master/example/run">guideline</a> to set up frameworkcontroller in the kubernetes cluster, NNI supports frameworkcontroller by the statefulset mode.</p>
</div>
<div class="section" id="design">
<h2>Design<a class="headerlink" href="#design" title="Permalink to this headline">¶</a></h2>
<p>Please refer the design of <a class="reference internal" href="KubeflowMode.html"><span class="doc">kubeflow training service</span></a>, frameworkcontroller training service pipeline is similar.</p>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>The frameworkcontroller config file format is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">authorName</span><span class="p">:</span> <span class="n">default</span>
<span class="n">experimentName</span><span class="p">:</span> <span class="n">example_mnist</span>
<span class="n">trialConcurrency</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">maxExecDuration</span><span class="p">:</span> <span class="mi">10</span><span class="n">h</span>
<span class="n">maxTrialNum</span><span class="p">:</span> <span class="mi">100</span>
<span class="c1">#choice: local, remote, pai, kubeflow, frameworkcontroller</span>
<span class="n">trainingServicePlatform</span><span class="p">:</span> <span class="n">frameworkcontroller</span>
<span class="n">searchSpacePath</span><span class="p">:</span> <span class="o">~/</span><span class="n">nni</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">trials</span><span class="o">/</span><span class="n">mnist</span><span class="o">/</span><span class="n">search_space</span><span class="o">.</span><span class="n">json</span>
<span class="c1">#choice: true, false</span>
<span class="n">useAnnotation</span><span class="p">:</span> <span class="n">false</span>
<span class="n">tuner</span><span class="p">:</span>
  <span class="c1">#choice: TPE, Random, Anneal, Evolution</span>
  <span class="n">builtinTunerName</span><span class="p">:</span> <span class="n">TPE</span>
  <span class="n">classArgs</span><span class="p">:</span>
    <span class="c1">#choice: maximize, minimize</span>
    <span class="n">optimize_mode</span><span class="p">:</span> <span class="n">maximize</span>
<span class="n">assessor</span><span class="p">:</span>
  <span class="n">builtinAssessorName</span><span class="p">:</span> <span class="n">Medianstop</span>
  <span class="n">classArgs</span><span class="p">:</span>
    <span class="n">optimize_mode</span><span class="p">:</span> <span class="n">maximize</span>
  <span class="n">gpuNum</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">trial</span><span class="p">:</span>
  <span class="n">codeDir</span><span class="p">:</span> <span class="o">~/</span><span class="n">nni</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">trials</span><span class="o">/</span><span class="n">mnist</span>
  <span class="n">taskRoles</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">worker</span>
      <span class="n">taskNum</span><span class="p">:</span> <span class="mi">1</span>
      <span class="n">command</span><span class="p">:</span> <span class="n">python3</span> <span class="n">mnist</span><span class="o">.</span><span class="n">py</span>
      <span class="n">gpuNum</span><span class="p">:</span> <span class="mi">1</span>
      <span class="n">cpuNum</span><span class="p">:</span> <span class="mi">1</span>
      <span class="n">memoryMB</span><span class="p">:</span> <span class="mi">8192</span>
      <span class="n">image</span><span class="p">:</span> <span class="n">msranni</span><span class="o">/</span><span class="n">nni</span><span class="p">:</span><span class="n">latest</span>
      <span class="n">frameworkAttemptCompletionPolicy</span><span class="p">:</span>
        <span class="n">minFailedTaskCount</span><span class="p">:</span> <span class="mi">1</span>
        <span class="n">minSucceededTaskCount</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">frameworkcontrollerConfig</span><span class="p">:</span>
  <span class="n">storage</span><span class="p">:</span> <span class="n">nfs</span>
  <span class="n">nfs</span><span class="p">:</span>
    <span class="n">server</span><span class="p">:</span> <span class="p">{</span><span class="n">your_nfs_server</span><span class="p">}</span>
    <span class="n">path</span><span class="p">:</span> <span class="p">{</span><span class="n">your_nfs_server_exported_path</span><span class="p">}</span>
</pre></div>
</div>
<p>If you use Azure Kubernetes Service, you should  set <code class="docutils literal notranslate"><span class="pre">frameworkcontrollerConfig</span></code> in your config YAML file as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">frameworkcontrollerConfig</span><span class="p">:</span>
  <span class="n">storage</span><span class="p">:</span> <span class="n">azureStorage</span>
  <span class="n">keyVault</span><span class="p">:</span>
    <span class="n">vaultName</span><span class="p">:</span> <span class="p">{</span><span class="n">your_vault_name</span><span class="p">}</span>
    <span class="n">name</span><span class="p">:</span> <span class="p">{</span><span class="n">your_secert_name</span><span class="p">}</span>
  <span class="n">azureStorage</span><span class="p">:</span>
    <span class="n">accountName</span><span class="p">:</span> <span class="p">{</span><span class="n">your_storage_account_name</span><span class="p">}</span>
    <span class="n">azureShare</span><span class="p">:</span> <span class="p">{</span><span class="n">your_azure_share_name</span><span class="p">}</span>
</pre></div>
</div>
<p>Note: You should explicitly set <code class="docutils literal notranslate"><span class="pre">trainingServicePlatform:</span> <span class="pre">frameworkcontroller</span></code> in NNI config YAML file if you want to start experiment in frameworkcontrollerConfig mode.</p>
<p>The trial’s config format for NNI frameworkcontroller mode is a simple version of frameworkcontroller’s offical config, you could refer the <a class="reference external" href="https://github.com/Microsoft/frameworkcontroller/blob/master/example/framework/scenario/tensorflow/cpu/tensorflowdistributedtrainingwithcpu.yaml">tensorflow example of frameworkcontroller</a> for deep understanding.Trial configuration in frameworkcontroller mode have the following configuration keys:</p>
<ul class="simple">
<li>taskRoles: you could set multiple task roles in config file, and each task role is a basic unit to process in kubernetes cluster.<ul>
<li>name: the name of task role specified, like “worker”, “ps”, “master”.</li>
<li>taskNum: the replica number of the task role.</li>
<li>command: the users’ command to be used in the container.</li>
<li>gpuNum: the number of gpu device used in container.</li>
<li>cpuNum: the number of cpu device used in container.</li>
<li>memoryMB: the memory limitaion to be specified in container.</li>
<li>image: the docker image used to create pod and run the program.</li>
<li>frameworkAttemptCompletionPolicy: the policy to run framework, please refer the <a class="reference external" href="https://github.com/Microsoft/frameworkcontroller/blob/master/doc/user-manual.md#frameworkattemptcompletionpolicy">user-manual</a> to get the specific information. Users could use the policy to control the pod, for example, if ps does not stop, only worker stops, this completionpolicy could helps stop ps.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="how-to-run-example">
<h2>How to run example<a class="headerlink" href="#how-to-run-example" title="Permalink to this headline">¶</a></h2>
<p>After you prepare a config file, you could run your experiment by nnictl. The way to start an experiment on frameworkcontroller is similar to kubeflow, please refer the <a class="reference internal" href="KubeflowMode.html"><span class="doc">document</span></a> for more information.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Customize_Tuner.html" class="btn btn-neutral float-right" title="Customize-Tuner" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="KubeflowMode.html" class="btn btn-neutral" title="Run an Experiment on Kubeflow" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Microsoft

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>