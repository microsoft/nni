jobs:
- job: 'integration_test_pai'
  pool:
    vmImage: 'Ubuntu 16.04'
  strategy:
    matrix:
      Python36:
        PYTHON_VERSION: '3.6'
  steps:
  - script: python3 -m pip install --upgrade pip setuptools --user
    displayName: 'Install python tools'

  - script: |
      cd deployment/pypi
      echo 'building prerelease package...'
      make version_ts=true build
      ls $(Build.SourcesDirectory)/deployment/pypi/dist/

    displayName: 'build nni bdsit_wheel'

  - script: |
      export IMG_TAG=itlatest
      cd deployment/pypi
      #docker login -u $(docker_hub_user) -p $(docker_hub_pwd)

      echo 'updating docker file for installing nni from local...'
      sed -ie 's/RUN python3 -m pip --no-cache-dir install nni/COPY .\/dist\/* .\nRUN python3 -m pip install nni-*.whl/' ../docker/Dockerfile
      cat ../docker/Dockerfile
      echo $IMG_TAG
      docker build -f ../docker/Dockerfile -t msranni/nni:$IMG_TAG .
      #docker push msranni/nni:$IMG_TAG
    displayName: 'build and upload nni docker image'
  #- script: |
  #    source install.sh
  #  displayName: 'Install nni toolkit via source code'

  - script: |
      cd test
      python3 generate_pai_config.py --pai_host $(pai_host) --pai_user $(pai_user) --pai_pwd $(pai_pwd) \
      --nni_docker_image $(nni_docker_image) --data_dir $(data_dir) --output_dir $(output_dir)
      PATH=$HOME/.local/bin:$PATH python3 config_test.py --ts pai
    displayName: 'integration test'
